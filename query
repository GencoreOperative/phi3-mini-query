#!/bin/bash

# A script that provides a file and a query about that file to
# the Phi3-Mini LLM. Handles argument parsing logic.

PROJECT="gencore/phi3-mini-query"

# Function to display usage information
usage() {
    echo "Usage: $0 -f FILE PROMPT"
    echo "Options:"
    echo "  -f FILE     Specify a file to read"
    echo "  PROMPT      Input string prompt from the user"
    exit 1
}

# Check if no arguments provided
if [ $# -eq 0 ]; then
    usage
fi

# Parse command line options
while getopts ":f:" opt; do
    case ${opt} in
        f )
            file="$OPTARG"
            ;;
        \? )
            echo "Invalid option: $OPTARG" 1>&2
            usage
            ;;
        : )
            echo "Invalid option: $OPTARG requires an argument" 1>&2
            usage
            ;;
    esac
done
shift $((OPTIND -1))

# Check if prompt is provided
if [ $# -eq 0 ]; then
    echo "Error: No prompt provided" >&2
    usage
fi

QUERY="Qustion: $@"

# Check if file option is provided
if [ -n "$file" ]; then
    if [ ! -f "$file" ]; then
        echo "Error: File '$file' not found" >&2
        exit 1
    fi
    file_content=$(cat "$file")
    QUERY="$QUERY\nSource: $file_content"
fi

docker run --rm -ti $PROJECT:latest "$QUERY"